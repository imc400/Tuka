-- ============================================
-- SCHEMA PARA CACHE DE PRODUCTOS - VERSI√ìN FINAL
-- ============================================
-- Este script es seguro: crea las tablas si no existen
-- y maneja errores si ya existen

-- ============================================
-- PASO 1: LIMPIEZA SEGURA
-- ============================================

-- Eliminar funciones primero (si existen)
DROP FUNCTION IF EXISTS search_products(text, text, integer) CASCADE;
DROP FUNCTION IF EXISTS update_updated_at_column() CASCADE;

-- Eliminar tablas en orden correcto (CASCADE elimina dependencias)
DROP TABLE IF EXISTS product_variants CASCADE;
DROP TABLE IF EXISTS products CASCADE;
DROP TABLE IF EXISTS sync_logs CASCADE;

-- ============================================
-- PASO 2: CREAR TABLAS
-- ============================================

-- 1. TABLA DE PRODUCTOS (Cache de Shopify)
CREATE TABLE products (
  id text PRIMARY KEY,                    -- Shopify product ID (texto)
  store_domain text NOT NULL,
  title text NOT NULL,
  description text,
  price numeric(10, 2) NOT NULL,
  compare_at_price numeric(10, 2),
  vendor text,
  product_type text,
  tags text[],
  images text[],
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  synced_at timestamp with time zone DEFAULT now(),
  available boolean DEFAULT true
);

COMMENT ON TABLE products IS 'Cache de productos de Shopify para performance';
COMMENT ON COLUMN products.id IS 'ID de Shopify (gid://shopify/Product/123)';

-- 2. TABLA DE VARIANTES
CREATE TABLE product_variants (
  id text PRIMARY KEY,
  product_id text NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  title text NOT NULL,
  price numeric(10, 2) NOT NULL,
  compare_at_price numeric(10, 2),
  sku text,
  barcode text,
  inventory_quantity integer DEFAULT 0,
  available boolean DEFAULT true,
  weight numeric(10, 2),
  weight_unit text,
  created_at timestamp with time zone DEFAULT now()
);

COMMENT ON TABLE product_variants IS 'Variantes de productos (tallas, colores)';

-- 3. TABLA DE LOGS DE SINCRONIZACI√ìN
CREATE TABLE sync_logs (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  store_domain text NOT NULL,
  status text NOT NULL CHECK (status IN ('success', 'error', 'in_progress')),
  products_synced integer DEFAULT 0,
  products_added integer DEFAULT 0,
  products_updated integer DEFAULT 0,
  products_deleted integer DEFAULT 0,
  error_message text,
  started_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  duration_seconds integer
);

COMMENT ON TABLE sync_logs IS 'Historial de sincronizaciones de productos';

-- ============================================
-- PASO 3: √çNDICES
-- ============================================

CREATE INDEX idx_products_store ON products(store_domain);
CREATE INDEX idx_products_type ON products(product_type);
CREATE INDEX idx_products_price ON products(price);
CREATE INDEX idx_products_available ON products(available) WHERE available = true;
CREATE INDEX idx_products_search ON products USING gin(to_tsvector('spanish', title || ' ' || COALESCE(description, '')));
CREATE INDEX idx_products_tags ON products USING gin(tags);

CREATE INDEX idx_variants_product ON product_variants(product_id);
CREATE INDEX idx_variants_available ON product_variants(available) WHERE available = true;

CREATE INDEX idx_sync_logs_store ON sync_logs(store_domain);
CREATE INDEX idx_sync_logs_started ON sync_logs(started_at DESC);
CREATE INDEX idx_sync_logs_status ON sync_logs(status);

-- ============================================
-- PASO 4: ROW LEVEL SECURITY
-- ============================================

ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE product_variants ENABLE ROW LEVEL SECURITY;
ALTER TABLE sync_logs ENABLE ROW LEVEL SECURITY;

-- Lectura p√∫blica (marketplace p√∫blico)
CREATE POLICY "products_select_policy" ON products
  FOR SELECT USING (true);

CREATE POLICY "variants_select_policy" ON product_variants
  FOR SELECT USING (true);

CREATE POLICY "logs_select_policy" ON sync_logs
  FOR SELECT USING (true);

-- Escritura permitida (para desarrollo)
CREATE POLICY "products_insert_policy" ON products
  FOR INSERT WITH CHECK (true);

CREATE POLICY "products_update_policy" ON products
  FOR UPDATE USING (true);

CREATE POLICY "products_delete_policy" ON products
  FOR DELETE USING (true);

CREATE POLICY "variants_insert_policy" ON product_variants
  FOR INSERT WITH CHECK (true);

CREATE POLICY "variants_update_policy" ON product_variants
  FOR UPDATE USING (true);

CREATE POLICY "variants_delete_policy" ON product_variants
  FOR DELETE USING (true);

CREATE POLICY "logs_insert_policy" ON sync_logs
  FOR INSERT WITH CHECK (true);

CREATE POLICY "logs_update_policy" ON sync_logs
  FOR UPDATE USING (true);

-- ============================================
-- PASO 5: FUNCIONES
-- ============================================

-- Funci√≥n para auto-actualizar updated_at
CREATE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger
CREATE TRIGGER products_updated_at_trigger
  BEFORE UPDATE ON products
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Funci√≥n de b√∫squeda full-text
CREATE FUNCTION search_products(
  search_query text,
  store_filter text DEFAULT NULL,
  limit_count integer DEFAULT 50
)
RETURNS TABLE (
  id text,
  store_domain text,
  title text,
  description text,
  price numeric,
  images text[],
  rank real
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    p.id,
    p.store_domain,
    p.title,
    p.description,
    p.price,
    p.images,
    ts_rank(
      to_tsvector('spanish', p.title || ' ' || COALESCE(p.description, '')),
      plainto_tsquery('spanish', search_query)
    ) as rank
  FROM products p
  WHERE
    to_tsvector('spanish', p.title || ' ' || COALESCE(p.description, ''))
    @@ plainto_tsquery('spanish', search_query)
    AND (store_filter IS NULL OR p.store_domain = store_filter)
    AND p.available = true
  ORDER BY rank DESC
  LIMIT limit_count;
END;
$$ LANGUAGE plpgsql;

-- ============================================
-- VERIFICACI√ìN FINAL
-- ============================================

DO $$
DECLARE
  products_count integer;
  variants_count integer;
  logs_count integer;
BEGIN
  SELECT COUNT(*) INTO products_count FROM information_schema.columns WHERE table_name = 'products';
  SELECT COUNT(*) INTO variants_count FROM information_schema.columns WHERE table_name = 'product_variants';
  SELECT COUNT(*) INTO logs_count FROM information_schema.columns WHERE table_name = 'sync_logs';

  RAISE NOTICE '';
  RAISE NOTICE '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó';
  RAISE NOTICE '‚ïë  ‚úÖ SCHEMA CREADO CORRECTAMENTE               ‚ïë';
  RAISE NOTICE '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù';
  RAISE NOTICE '';
  RAISE NOTICE 'üìä Resumen:';
  RAISE NOTICE '   ‚Ä¢ Tabla products: % columnas', products_count;
  RAISE NOTICE '   ‚Ä¢ Tabla product_variants: % columnas', variants_count;
  RAISE NOTICE '   ‚Ä¢ Tabla sync_logs: % columnas', logs_count;
  RAISE NOTICE '';
  RAISE NOTICE 'üöÄ Pr√≥ximo paso: Ejecutar npm run sync';
  RAISE NOTICE '';
END $$;
